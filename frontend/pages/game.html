<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles/style.css">
    <title>Game - Onitama</title>
</head>
<body>
    <header>
        <div class="logo-sml">
            <img src="../assets/svg/ONITAMALOGO.svg" alt="Onitama">
        </div>
        <a href="#" class="leave-link">Leave Game</a>
    </header>
    <div class="games-container-2">
        <div class="game-status">
            <h1 class="update">Waiting</h1>
            <h1 class="time">2:00</h1>
        </div>
        <div class="game-content">
            <div class="game-board">
                
            </div>
            <div class="game-cards">
                <div class="cards-opposite">
                    <div class="card">
                        <img src="../assets/svg/cards/Boar.svg" alt="Card">
                    </div>
                    <div class="card">
                        <img src="../assets/svg/cards/Boar.svg" alt="Card">
                    </div>
                    <div class="card">
                        <img src="../assets/svg/cards/Boar.svg" alt="Card">
                    </div>
                </div>
                <div class="cards-player">
                    <div class="card">
                        <img src="../assets/svg/cards/Boar.svg" alt="Card">
                    </div>
                    <div class="card">
                        <img src="../assets/svg/cards/Boar.svg" alt="Card">
                    </div>
                    <div class="card">
                        <img src="../assets/svg/cards/Boar.svg" alt="Card">
                    </div>
                </div>
            </div>
        </div>
        <div class="game-info">
            <p>Wait until other player joins...</p>
            <div class="gameid-info">
                <p class="gameid-status">Waiting</p>
                <p class="gameid-num">#33</p>
                <div class="gameid-code-container" style="display: none">
                    <p class="gameid-code">ABC123</p>
                </div>
            </div>
        </div>
    </div>
    <script>
        async function fetchGameInfo(gameId, token) {
            try {
                const response = await fetch(`https://se.ifmo.ru/~s341995/api/games/${gameId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token,
                        game_id: gameId
                    })
                });

                if (!response.ok) {
                    alert(`HTTP error! status: ${response.status}`);
                    return null;
                }

                const data = await response.json();
                
                // Store game information
                const gameInfo = {
                    gameId: gameId,
                    playerId: data.querying_player.player_id,
                    playerColor: data.querying_player.color,
                    status: data.status,
                    remainingTime: data.remaining_time,
                    currentMove: data.current_move
                };

                // Store in localStorage
                const storageKey = `game_${gameId}`;
                localStorage.setItem(storageKey, JSON.stringify(gameInfo));
                
                return gameInfo;
            } catch (error) {
                alert(`Error fetching game info: ${error.message}`);
                return null;
            }
        }

        function createBoard(playerColor) {
            const gameBoard = document.querySelector('.game-board');
            
            // Create 5x5 grid
            for (let i = 0; i < 25; i++) {
                const cell = document.createElement('div');
                cell.className = 'board-cell';
                cell.dataset.row = Math.floor(i / 5);
                cell.dataset.col = i % 5;
                gameBoard.appendChild(cell);
            }
            
            // Initial piece setup based on player color
            setupInitialPieces(playerColor);
        }

        function setupInitialPieces(playerColor) {
            const isPlayerBlue = playerColor === 'blue';
            
            // Player's pieces (bottom)
            createPiece(4, 0, playerColor);
            createPiece(4, 1, playerColor);
            createPiece(4, 2, playerColor, true); // Master
            createPiece(4, 3, playerColor);
            createPiece(4, 4, playerColor);
            
            // Opponent's pieces (top)
            const opponentColor = isPlayerBlue ? 'red' : 'blue';
            createPiece(0, 0, opponentColor);
            createPiece(0, 1, opponentColor);
            createPiece(0, 2, opponentColor, true); // Master
            createPiece(0, 3, opponentColor);
            createPiece(0, 4, opponentColor);
        }

        function createPiece(row, col, color, isMaster = false) {
            const cell = document.querySelector(`.board-cell[data-row="${row}"][data-col="${col}"]`);
            const piece = document.createElement('div');
            piece.className = `piece ${color}${isMaster ? ' master' : ''}`;
            cell.appendChild(piece);
        }

        function updateGameDisplay(gameInfo) {
            if (!gameInfo) {
                alert('Error: Invalid game info');
                return;
            }

            // Update game status
            document.querySelector('.update').textContent = gameInfo.currentMove ? 
                `${gameInfo.currentMove.color.charAt(0).toUpperCase() + gameInfo.currentMove.color.slice(1)} move` : 
                'Waiting';

            // Update game ID
            document.querySelector('.gameid-num').textContent = `#${gameInfo.gameId}`;

            // Update game status
            document.querySelector('.gameid-status').textContent = 
                gameInfo.status.charAt(0).toUpperCase() + gameInfo.status.slice(1);

            // Update timer
            const minutes = Math.floor(gameInfo.remainingTime / 60);
            const seconds = gameInfo.remainingTime % 60;
            document.querySelector('.time').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('id');
            
            if (!gameId) {
                alert('Error: No game ID provided');
                return;
            }

            const token = localStorage.getItem('token');
            if (!token) {
                alert('Error: No authentication token found');
                return;
            }

            // Fetch initial game state
            const gameInfo = await fetchGameInfo(gameId, token);
            if (gameInfo) {
                createBoard(gameInfo.playerColor);
                updateGameDisplay(gameInfo);

                // Set up periodic refresh
                setInterval(async () => {
                    const updatedInfo = await fetchGameInfo(gameId, token);
                    if (updatedInfo) {
                        updateGameDisplay(updatedInfo);
                    }
                }, 5000); // Refresh every 5 seconds
            }
        });
    </script>
</body>
</html>